* Generate maps of all lines from the PZ cube
- Find what steps need to be repeated from the list in [[file:ngc-346-drl-spectra.org]]
  - Continuum subtraction ([[id:59F3D73A-6179-462C-86E8-1F915C76E274][Step -1]])
  - Maps of different lines ([[id:B915BA48-D7C9-4FFE-9ECF-511CBF1A4ED7][Step 4]])
** DONE Continuum subtraction
CLOSED: [2024-05-09 Thu 11:37]
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-05-09 Thu 11:37] \\
  This is done for now, but I may need to revisit it later if I want another intermediate sied window between 011 and 101
- State "TODO"       from              [2024-05-09 Thu 11:20] \\
  This needs to be re-run for each window size of the PZ file now that I have trimmed off a column.
:END:
- This uses the median filter method
- Previously, filtered cube files had been written out to [[file:../big-data/ngc346new/]]
  - I might as well write them out in the same place, but with a different prefix
- I have done the following window sizes in the terminal, since it takes a while
  - [X] 7
  - [X] 11
  - [X] 101
#+begin_src sh :dir ../big-data/ngc346new/ :results output verbatim :eval no
  time python ../../lib/median_continuum.py\
       --two-pass \
       --out-prefix n346-PZ-2pass \
       --cube-name PeterZeidler/DATACUBE_FINAL_fwhm_cor_trim.fits \
       11
#+end_src

#+RESULTS:
: /Users/will/Dropbox/muse-hii-regions/big-data/ngc346new

- I have repeated this for window widths of 7, 11, 101
** DONE [#A] Fixing the map size discrepancy once and for all
CLOSED: [2024-05-09 Thu 11:19]
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-05-09 Thu 11:19] \\
  I ran this and it seems to have worked. Now to redo all the downstream steps
:END:
- (3801,326,347) is the size of the PZ cube, but (3801,326,346) is the size of the ESO cube
- This difference has caused me no end of pain, and half-assed attempts to fix it have had unwanted knock-on effects, since all my previous workflow assumes the ESO cube size
- The only sane thing to do is to trim off a column from the PZ cube right at the start, so we can just avoid the entire issue
  - This means I will have to rerun the median filters, but that is a small price to pay

#+begin_src python :tangle ../scripts/trim-cube.py
  from astropy.io import fits
  import numpy as np
  import typer
  from pathlib import Path


  def main(
      hdu_index: int = 1,
      cube_name: str = "PeterZeidler/DATACUBE_FINAL_fwhm_cor.fits",
      data_path=Path.home() / "Work/Muse-Hii-Data/SMC-NGC-346",
      extra_suffix: str = "_trim",
      target_shape: tuple[int, int, int] = (3801, 326, 346),
  ):
      # Open the FITS file
      hdu = fits.open(data_path / cube_name)[hdu_index]
      # Trim off the rightmost column
      hdu.data = hdu.data[..., :-1]
      # Check shape of result
      assert hdu.data.shape == target_shape

      # Write the new FITS file
      hdu.writeto(data_path / cube_name.replace(".fits", f"{extra_suffix}.fits"), overwrite=True)


  if __name__ == "__main__":
      typer.run(main)
#+end_src

#+header: :prologue "exec 2>&1" :epilogue ":"
#+begin_src sh :dir ../big-data/ngc346new/ :results output verbatim
  time python ../../scripts/trim-cube.py
#+end_src

#+RESULTS:
: 
: real	0m46.969s
: user	0m26.132s
: sys	0m6.325s

** Image maps


*** First try and make the rainbow maps
Start off with the ESO cube. This differs from what we did previously in that it uses the 2pass 007 filtered cube
#+begin_src sh :dir ../data/spec1d :results output file
  python ../../scripts/peak-image-plot.py \
         ../../big-data/ngc346new/n346-muse-2pass-csub-007.fits \
         n346-nostar-bs-peaks-p0010-d0030.csv \
         --ncolumns 8 \
         --no-subtract-base \
         --wavelength-window-pad 0.5 \
         --extra-suffix ESO007
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/spec1d/peak-images-n346-nostar-bs-peaks-p0010-d0030-ESO007.pdf]]

Now the PZ one

#+begin_src sh :dir ../data/spec1d :results output file
  python ../../scripts/peak-image-plot.py \
         ../../big-data/ngc346new/n346-PZ-2pass-csub-007.fits \
         n346-nostar-bs-peaks-p0010-d0030.csv \
         --ncolumns 8 \
         --no-subtract-base \
         --wavelength-window-pad 0.5 \
         --extra-suffix PZ007
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/spec1d/peak-images-n346-nostar-bs-peaks-p0010-d0030-PZ007.pdf]]

That one is OK

#+begin_src sh :dir ../data/spec1d :results output file
  python ../../scripts/peak-image-plot.py \
         ../../big-data/ngc346new/n346-PZ-2pass-csub-007.fits \
         n346-nostar-bs-peaks-p0010-d0030.csv \
         --ncolumns 8 \
         --subtract-base \
         --wavelength-window-pad 0.5 \
         --extra-suffix PZ007B
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/spec1d/peak-images-n346-nostar-bs-peaks-p0010-d0030-PZ007B.pdf]]

That one is terrible. We should not subtract the base

#+begin_src sh :dir ../data/spec1d :results output file
  python ../../scripts/peak-image-plot.py \
         ../../big-data/ngc346new/n346-PZ-2pass-csub-101.fits \
         n346-nostar-bs-peaks-p0010-d0030.csv \
         --ncolumns 8 \
         --no-subtract-base \
         --wavelength-window-pad 0.5 \
         --extra-suffix PZ101
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/spec1d/peak-images-n346-nostar-bs-peaks-p0010-d0030-PZ101.pdf]]

And that one is mostly fine too. 
*** Now make all the individual maps
- It turns out that the [[file:../scripts/make-one-map.py][make-one-map.py]] script uses info from the spreadsheet to decide how to extract the line and from which median-filtered image.
- I would rather use a homogeneous approach this time
- And more efficient to do all the lines at once, so we do not need to keep reading in the same cube file
**** DONE New version of map script
CLOSED: [2024-05-09 Thu 13:11]
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-05-09 Thu 13:11] \\
  Re-run this for all PZ cubes after doing the column trimming
:END:
- The yaml files are in [[file:../data/n346-lines/all-lines-orig/]]
- I will make a new folder [[file:../data/n346-bow-lines/]] to store the maps
  - This will have sub-folders named after the particular median-filtered cube, such as [[file:../data/n346-bow-lines/maps-n346-PZ-2pass-csub-007/]]
- Unlike previous scripts, this finds all paths relative to the project root directory, which may or may not be a good idea
  - We can run it from the [[file:../scripts/]] directory or the [[file:../data/]] directory, or anywhere else that is one level down from the project root (or otherwise use the ~--project-root~ option)
#+begin_src python :tangle ../scripts/make-all-3wav-maps.py
  import numpy as np
  import sys
  from pathlib import Path
  import typer
  import yaml
  import slugify
  from text_unidecode import unidecode
  from astropy.io import fits
  from astropy.wcs import WCS

  unwanted_types = ["sky", "telluric", "noise", "nan", "stellar"]


  def get_line_type(s):
      if s is None:
          return None
      ltype = slugify.slugify(str(s).rstrip("?"))
      if not ltype or ltype in unwanted_types:
          return None
      else:
          return ltype


  def load_cube_hdu(
      cube_path: Path,
  ):
      return fits.open(cube_path)[0]


  def get_id_string(data):
      s = f"{data['Index']:04d}-"
      s += slugify.slugify(data["ID"])
      if "UIL" in data["ID"]:
          s += "-" + slugify.slugify(f"{data['lambda_HM']:.2f}")
      return s


  def main(
      cube_file: str = "n346-muse-2pass-csub-007.fits",
      project_root: Path = Path("../"),
      yaml_folder: str = "data/n346-lines/all-lines-orig",
      maps_folder: str = "data/n346-bow-lines",
  ):
      """Create ABC channel maps of all emission lines from data in YAML files"""


      # Get the spectral cube
      big_data_folder = project_root / "big-data" / "ngc346new"
      cube_path = big_data_folder / f"{cube_file}"
      cube = load_cube_hdu(cube_path)

      # The YAML files contain metadata for each line
      yaml_files = (project_root / yaml_folder).glob("*.yaml")
      # Loop over all the lines
      for yaml_file in yaml_files:
          with open(yaml_file) as f:
              metadata = yaml.safe_load(f)
          # Group all lines of same type into their own folder
          line_type = get_line_type(metadata["Type"])
          if line_type is None:
              # Skip unwanted types
              continue

          # Make folder for this line type if necessary
          save_path = project_root / maps_folder / f"maps-{cube_path.stem}" / f"type-{line_type}" 
          save_path.mkdir(exist_ok=True, parents=True)

          ipeak = metadata["Index"]
          # Save each of 3 channels as a separate FITS file
          images = {}
          for chan_label, ichan in zip(["A", "B", "C"], [ipeak - 1, ipeak, ipeak + 1]):
              images[chan_label] = cube.data[ichan, ...]
          # And also the moments
          images["ABC"] = images["A"] + images["B"] + images["C"]
          images["m1"] = (images["C"] - images["A"]) / images["ABC"]
          images["m2"] = (images["C"] + images["A"]) / images["ABC"]
          header = WCS(cube.header).celestial.to_header()
          # FITS headers allow only ASCII strings
          header.update({k: unidecode(str(v)) for k, v in metadata.items()})
          for label, image in images.items():
              fits_file = get_id_string(metadata) + f"-{label}.fits"
              fits.PrimaryHDU(header=header, data=image).writeto(
                  save_path / fits_file, overwrite=True
              )
          print("Image saved to", save_path / f"{get_id_string(metadata)}-*.fits")


  if __name__ == "__main__":
      typer.run(main)
#+end_src



#+begin_src sh :dir ../data :results verbatim :eval no
python ../scripts/make-all-3wav-maps.py --cube-file n346-muse-2pass-csub-007.fits
#+end_src

#+begin_src sh :dir ../data :results verbatim
python ../scripts/make-all-3wav-maps.py --help 
#+end_src

#+RESULTS:
#+begin_example
                                                                                
 Usage: make-all-3wav-maps.py [OPTIONS]                                         
                                                                                
 Create ABC channel maps of all emission lines from data in YAML files          
                                                                                
╭─ Options ────────────────────────────────────────────────────────────────────╮
│ --cube-file           TEXT  [default: n346-muse-2pass-csub-007.fits]         │
│ --project-root        PATH  [default: ..]                                    │
│ --yaml-folder         TEXT  [default: data/n346-lines/all-lines-orig]        │
│ --maps-folder         TEXT  [default: data/n346-bow-lines]                   │
│ --help                      Show this message and exit.                      │
╰──────────────────────────────────────────────────────────────────────────────╯

#+end_example
** DONE Spectra of each zone
CLOSED: [2024-05-21 Tue 13:30]
:LOGBOOK:
- State "TODO"       from              [2024-05-09 Thu 10:03] \\
  I need to do this so I can have a panel in my [[id:376C7C7C-FE81-48F2-8D6E-DF06BC2274C5][quality assurance figures]] that shows the spectra around each line
:END:
- For a first pass on this, I will use the same zones as in the H_2 lines project
  - Eventually, we could maybe redo the zones using the new maps for consistency, although I cannot imagine that it will make much difference.
- The zones are defined in [[file:../data/n346-lines/zones.yaml]]
- The map of zone indices is in [[file:../data/n346-lines/zone-indices.fits]]
- Then there are mask files for each zone in [[file:../data/n346-lines/zone-IV-mask.fits]] etc
  - These are what we should use to extract the spectra
- It looks like I used a really space-inefficient method for doing the zones spectra: I first make an entire masked cube for each zone, then extract the spectra from that
  - Never mind, I will do the same - disk space is not a problem
  -
*** DONE Define a background (BG) zone
CLOSED: [2024-05-10 Fri 13:26]
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-05-10 Fri 13:26] \\
  Decided to go for a border of 10 pixels to avoid the noise around the edges
:END:
- It looks like I may be able to improve things by subtracting off a background, so I am next going to define a new zone to the north of the map where there is very little emission apart from some neutral lines
- Looking at the zone-*-bright-map.fits files, it looks like a combination of two criteria will work:
  - III < -0.1
  - S < 0.2
- This will select a couple of regions in the north where nothing is happening


#+begin_src python :tangle ../scripts/make-bg-zone-mask.py 
  from pathlib import Path
  import numpy as np
  from astropy.io import fits
  import yaml
  import typer

  def trim_pixel_border_from_mask(mask: np.ndarray, border: int) -> np.ndarray:
      """Set to False all pixels within certain border of mask array"""
      assert mask.ndim == 2
      mask2 = np.zeros_like(mask)
      # Easier to set the pixels that we do not want to set to FALSE
      mask2[border:-border,  border:-border] = True
      # and just AND it with the original
      return mask & mask2

  BG_THRESHOLDS = [("III", -0.1), ("S", 0.2)]


  def main(
          trim_border: int=5,
  ):
      """Write a fits image file for the BG zone mask"""

      # Initialise the mask to all True
      mask = None
      # For each criterion, set to False any pixels that do not meet it
      for zlabel, threshold in BG_THRESHOLDS:
          zone_bright_map = fits.open(f"zone-{zlabel}-bright-map.fits")[0]
          if mask is None:
              mask = zone_bright_map.data < threshold
          else:
              mask = mask & (zone_bright_map.data < threshold)
      # And trim around the border to avoid noisy pixels
      mask = trim_pixel_border_from_mask(mask, trim_border)
      maskfilename = f"zone-BG-mask.fits"
      fits.PrimaryHDU(
          header=zone_bright_map.header,
          data=mask.astype(int),
      ).writeto(maskfilename, overwrite=True)
      print("Saved mask to", maskfilename)

  if __name__ == "__main__":
      typer.run(main)

  #+end_src

  #+RESULTS:

#+begin_src sh :results output verbatim :dir ../data/n346-lines
  python ../../scripts/make-bg-zone-mask.py --trim-border 10
#+end_src

#+RESULTS:
: Saved mask to zone-BG-mask.fits
*** DONE Generate the masked cube for the BG zone
CLOSED: [2024-05-10 Fri 13:35]
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-05-10 Fri 13:35] \\
  Done for 3 PZ windows and one ESO window
:END:
#+header: :prologue "exec 2>&1" :epilogue ":"
#+begin_src sh :results output verbatim :dir ../data/n346-lines
  z=BG
  time for w in 007 011 101; do
      python ../../scripts/make-masked-cube.py \
       ../../big-data/ngc346new/n346-PZ-2pass-csub-$w.fits \
       zone-$z-mask.fits \
       zone-$z
  done
  echo "Last run:"
  date
#+end_src

#+RESULTS:
: WARNING: UnitsWarning: '1e-20 erg/s/cm  2/Angstrom' contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
: WARNING: UnitsWarning: '1e-20 erg/s/cm  2/Angstrom' contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
: WARNING: UnitsWarning: '1e-20 erg/s/cm  2/Angstrom' contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
: 
: real	1m6.621s
: user	0m31.011s
: sys	0m20.328s
: Last run:
: Fri May 10 13:30:22 CST 2024

Repeat for the ESO cube
#+begin_src sh :results output verbatim :dir ../data/n346-lines
  z=BG
  time for w in 007; do
      python ../../scripts/make-masked-cube.py \
       ../../big-data/ngc346new/n346-muse-2pass-csub-$w.fits \
       zone-$z-mask.fits \
       zone-$z
  done
  echo "Last run:"
  date
#+end_src

#+RESULTS:
: Last run:
: Fri May 10 13:44:59 CST 2024

*** DONE Generate the masked cubes for each zone
CLOSED: [2024-05-09 Thu 11:39]
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-05-09 Thu 11:39] \\
  Done for 007, 011, and 101
:END:
First the 007 window
#+header: :prologue "exec 2>&1" :epilogue ":"
#+begin_src sh :results output verbatim :dir ../data/n346-lines
  time for z in 0 I II III IV MYSO S BG; do
      python ../../scripts/make-masked-cube.py \
       ../../big-data/ngc346new/n346-PZ-2pass-csub-007.fits \
       zone-$z-mask.fits \
       zone-$z
  done
  echo "Last run:"
  date
#+end_src

#+RESULTS:
#+begin_example
WARNING: UnitsWarning: '1e-20 erg/s/cm  2/Angstrom' contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
WARNING: UnitsWarning: '1e-20 erg/s/cm  2/Angstrom' contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
WARNING: UnitsWarning: '1e-20 erg/s/cm  2/Angstrom' contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
WARNING: UnitsWarning: '1e-20 erg/s/cm  2/Angstrom' contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
WARNING: UnitsWarning: '1e-20 erg/s/cm  2/Angstrom' contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
WARNING: UnitsWarning: '1e-20 erg/s/cm  2/Angstrom' contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]

real	2m7.901s
user	1m13.664s
sys	0m42.645s
Last run:
Thu May  9 11:27:34 CST 2024
#+end_example

Now the 101 window. This one I run in the terminal so as not to block the notebook. And I do the same for the 011 window

#+header: :prologue "exec 2>&1" :epilogue ":"
#+begin_src sh :results output verbatim :dir ../data/n346-lines :eval no
  time for z in I II III IV MYSO S; do
      python ../../scripts/make-masked-cube.py \
       ../../big-data/ngc346new/n346-PZ-2pass-csub-101.fits \
       zone-$z-mask.fits \
       zone-$z
  done
  echo "Last run:"
  date
#+end_src

Somehow I forgot the Zone 0 case

#+header: :prologue "exec 2>&1" :epilogue ":"
#+begin_src sh :results output verbatim :dir ../data/n346-lines
  z=0
  time for w in 007 011 101; do
      python ../../scripts/make-masked-cube.py \
       ../../big-data/ngc346new/n346-PZ-2pass-csub-$w.fits \
       zone-$z-mask.fits \
       zone-$z
  done
  echo "Last run:"
  date
#+end_src

#+RESULTS:
: WARNING: UnitsWarning: '1e-20 erg/s/cm  2/Angstrom' contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
: WARNING: UnitsWarning: '1e-20 erg/s/cm  2/Angstrom' contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
: WARNING: UnitsWarning: '1e-20 erg/s/cm  2/Angstrom' contains multiple slashes, which is discouraged by the FITS standard [astropy.units.format.generic]
: 
: real	1m1.540s
: user	0m30.565s
: sys	0m18.825s
: Last run:
: Thu May  9 11:56:20 CST 2024

*** DONE Extract the spectra from each zone
CLOSED: [2024-05-09 Thu 13:06]
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-05-09 Thu 13:06] \\
  Finished the version with mean and without any chopping off for all the PZ windows and the 007 ESO window
:END:
Unlike with the previous project, we do not necessarily want to chop off the south filament, so we will initially try it with the entire cube

#+header: :prologue "exec 2>&1" :epilogue ":"
#+begin_src sh :results output verbatim :dir ../data/n346-bow-lines
  time for z in 0 I II III IV MYSO S; do
      python ../../scripts/extract-zone-spectrum.py \
       ../../big-data/ngc346new/n346-PZ-2pass-csub-007-zone-$z.fits \
       zone-$z-P-007-mean
  done
  echo "Last run:"
  date
#+end_src

#+RESULTS:
: /Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/../../scripts/extract-zone-spectrum.py:14: RuntimeWarning: Mean of empty slice
:   spec = reduction_method(
: 
: real	0m57.864s
: user	0m25.488s
: sys	0m13.890s
: Last run:
: Thu May  9 11:57:26 CST 2024

Also done for the 011 and 101 windows. And for the ESO cube with 007 window

Repeat for the new BG zone

#+header: :prologue "exec 2>&1" :epilogue ":"
#+begin_src sh :results output verbatim :dir ../data/n346-bow-lines
  z=BG
  time python ../../scripts/extract-zone-spectrum.py \
         ../../big-data/ngc346new/n346-PZ-2pass-csub-007-zone-$z.fits \
         zone-$z-P-007-mean
  time python ../../scripts/extract-zone-spectrum.py \
         ../../big-data/ngc346new/n346-PZ-2pass-csub-011-zone-$z.fits \
         zone-$z-P-011-mean
  time python ../../scripts/extract-zone-spectrum.py \
         ../../big-data/ngc346new/n346-PZ-2pass-csub-101-zone-$z.fits \
         zone-$z-P-101-mean
  time python ../../scripts/extract-zone-spectrum.py \
         ../../big-data/ngc346new/n346-muse-2pass-csub-007-zone-$z.fits \
         zone-$z-E-007-mean
  echo "Last run:"
  date
#+end_src

#+RESULTS:
#+begin_example
/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/../../scripts/extract-zone-spectrum.py:14: RuntimeWarning: Mean of empty slice
  spec = reduction_method(

real	0m4.090s
user	0m3.313s
sys	0m1.645s
/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/../../scripts/extract-zone-spectrum.py:14: RuntimeWarning: Mean of empty slice
  spec = reduction_method

real	0m4.043s
user	0m3.340s
sys	0m1.603s

real	0m4.047s
user	0m3.318s
sys	0m1.601s

real	0m4.100s
user	0m3.355s
sys	0m1.612s
Last run:
Fri May 10 13:45:43 CST 2024
#+end_example

** Initial impressions of the PZ maps
- These are a lot better than I had expected
- Maybe we can just use these, instead of trying to use them to calibrate the ESO ones
- No, they have the same old problem with the weak lines
*** Some lines that may need tweaking
- The [Ar IV] aurora lines are a bit weird
  - I suspect that the central pixel may be off by one in some cases
  - [Ar IV] 7170.5 has no obvious blend
    - actually this one might be well-centered after all
      |         |   A |   B |    C |    m1 |   m2 |
      |---------+-----+-----+------+-------+------|
      | BG      | 3.5 | 4.0 | -2.2 | -1.08 | 0.25 |
      | BS      | 5.5 | 6.7 | -1.3 | -0.62 | 0.39 |
      | BS - BG | 2.0 | 2.7 |  0.9 | -0.20 | 0.52 |
      |         |     |     |      |   0/0 |  0/0 |
      #+TBLFM: $5=($4-$2)/($2 + $3 + $4);f2::$6=($4+$2)/($2 + $3 + $4);f2::@4$2..@4$4=@3-@2;f1
    - 
  - [Ar IV] 7237.4 has a blend with an H_2 line, so is listed under that
  - [Ar IV] 7262.7 has a blend with [Cl IV] 7261.4, but it is not so apparent
** Comparing different versions of the maps
- We have two sorts of comparisons that we want to carry out:
  - Different filter window sizes for the PZ maps
  - Between the PZ and ESO maps
- We will first write a script that does a comparison for a single line
  - Shows the ABC color images of the two lines
  - Shows the 2d histogram of the sum, m1, and m2 values
*** Summary of results from the PZ-ESO comparison
- The key to success here was in subtracting the BG zone from both cubes
  - For the ESO cube, this leads to positive pine brightnesses every where, which is good!
  - For the PZ cube, this removes the garbage features around an intensity of 20, which effected the weak lines

*** DONE Script to compare two maps
CLOSED: [2024-05-21 Tue 13:31]
:PROPERTIES:
:ID:       376C7C7C-FE81-48F2-8D6E-DF06BC2274C5
:END:
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-05-21 Tue 13:31] \\
  This was a mammoth undertaking, but now it is finally done. The only thing I might want to revisit is to add indication of hyper-local continuum pixels in the spectra graphs
:END:
- This has now expanded into an all singing, all dancing figure, which I am refering to as the Quality Assurance (QA) plot
- [2024-05-10 Fri] Future plans are as follows
  - [X] Define a BG zone to extract a spectrum that we will subtract from all the other zones
    - I am hoping that this will allows us to eliminate all the rubbish that we see in the PZ spectra of the faint lines with an amplitude of about 5
    - Possibly it also might help to fix the oversubtraction in the ESO spectra with bright lines, similar to what I did by hand on a line-by-line basis in the jupyter notebooks
  - [X] Add a map of the zones as the central panel of the figure
    - This should show contours of the masked brightness
    - And superimposed on translucent coloring of the zones
  - [X] Weight the histograms by the brightness of the pixels
  - [X] Add marginal histograms to the 2d histograms
  - [X] Option to remove a border of pixels from the maps
    - important for the weak lines, where the left and right edges in
      particuar are very noisy
  - [X] Add mean moments for different zones to the stats figures
  - [X] Use a consistent color scheme for the zones, based on a key
    color with varying saturation and/or brightness
  - [X] Change to nebular frame of reference for the wavelength axis
    - And mark on the rest wavelength in the spectral plots and the
      moment distros
  - [X] Change the normalization of the spectra to only use the ABC
    pixels
    - This allows us to see wek lines that zre very close to a much
      stronger line, such as He I 5015.68
  - [X] Write out FITS images of the BG-subtracted maps for later
    analysis in the notebooks
  - [X] Center the spectral plots on the rest wavelength
  - [X] Add legend to the spectral plots and use better names for the
    combo zones:
    - Bow shock for IV
    - Diffuse for I,III
    - Filaments for 0,II
  - [X] Optionally fix the baseline using the hyper-local continuum
    - To avoid adding noise, this will be a global fix that uses the
      line profile from the combined I,III,IV zones
    - We can use the pixels that are peak - 3 and peak + 3 in the
      combined spectrum to make sure we have escaped from the line wings
- The script is in file:../scripts/compare-two-maps.py
  - It used to be in this org file, but it got too big

 

#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line h-i-6562-79 --bcombo E-007 --subtract-bg --trim-edges 10
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-h-i-6562-79.pdf]]



*** Usage documentation for the comparison script
#+begin_src sh :dir ../data/n346-bow-lines :results verbatim
python ../../scripts/compare-two-maps.py --help 
#+end_src

#+RESULTS:
#+begin_example
                                                                                
 Usage: compare-two-maps.py [OPTIONS]                                           
                                                                                
╭─ Options ────────────────────────────────────────────────────────────────────╮
│ --acombo                                       TEXT     [default: P-007]     │
│ --bcombo                                       TEXT     [default: E-007]     │
│ --line                                         TEXT     [default:            │
│                                                         h-i-6562-79]         │
│ --histogram-gamma                              FLOAT    [default: 2.0]       │
│ --smooth                                       FLOAT    [default: 0.0]       │
│ --mask-out-stars        --no-mask-out-stars             [default:            │
│                                                         no-mask-out-stars]   │
│ --star-mask-thresho…                           FLOAT    [default: 10.0]      │
│ --star-map-path                                PATH     [default:            │
│                                                         /Users/will/Dropbox… │
│ --zones-folder                                 PATH     [default:            │
│                                                         /Users/will/Dropbox… │
│ --subtract-bg           --no-subtract-bg                [default:            │
│                                                         no-subtract-bg]      │
│ --trim-edges                                   INTEGER  [default: 0]         │
│ --vsys                                         FLOAT    [default: 171.1]     │
│ --mark-moments-bow-…    --no-mark-moments-…             [default:            │
│                                                         no-mark-moments-bow… │
│ --mark-moments-nebu…    --no-mark-moments-…             [default:            │
│                                                         no-mark-moments-neb… │
│ --mark-moments-fila…    --no-mark-moments-…             [default:            │
│                                                         no-mark-moments-fil… │
│ --help                                                  Show this message    │
│                                                         and exit.            │
╰──────────────────────────────────────────────────────────────────────────────╯

#+end_example

*** DONE Debugging the comparison script
CLOSED: [2024-05-21 Tue 13:33]
#+header: :prologue "exec 2>&1" :epilogue ":"
#+begin_src sh :dir ../data/n346-bow-lines :results output verbatim
  python ../../scripts/compare-two-maps.py --line h-i-8345-55 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 10 --subtract-bg --fix-continuum --debug
#+end_src

#+RESULTS:
: Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
: Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
: Hyper-local continuum: -4.60, -3.06
: Subtracting hyper-local continuum from RGB and ABC images
: Median m2 = 0.6127645104718388 original m2 = 0.5414611150166987
: maps-compare/P-007-P-101-h-i-8345-55.pdf

*** DONE Run the comparison script on all the lines
CLOSED: [2024-05-21 Tue 13:33]

**** He II lines
#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line he-ii-4685-68 --bcombo E-007 --smooth 3 --mask-out-stars --star-mask-threshold 1.0 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-he-ii-4685-68.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line he-ii-4685-68 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 0.5 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-ii-4685-68.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-ii-8236-78 --bcombo E-007 --smooth 5 --mask-out-stars --star-mask-threshold 2 --subtract-bg --fix-continuum --hyper-local-blue 2 --hyper-local-red 2 --trim-edges 30
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-he-ii-8236-78.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line he-ii-8236-78 --bcombo P-101 --smooth 5 --mask-out-stars --star-mask-threshold 2 --subtract-bg --fix-continuum --hyper-local-blue 2 --hyper-local-red 2 --trim-edges 30
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-ii-8236-78.pdf]]

**** High ionization forbidden lines: [Ar/Cl/K IV] 
:PROPERTIES:
:ORDERED:  t
:END:
#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line ar-iv-4740-17 --bcombo E-007 --smooth 3 --mask-out-stars --subtract-bg --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-ar-iv-4740-17.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line ar-iv-4740-17 --bcombo P-101 --smooth 3 --mask-out-stars --subtract-bg --trim-edges 11 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-ar-iv-4740-17.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line ar-iv-4740-17 --bcombo P-011 --smooth 3 --mask-out-stars --subtract-bg --trim-edges 11 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-011-ar-iv-4740-17.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line k-iv-6101-79 --bcombo E-007 --smooth 5 --mask-out-stars --star-mask-threshold 2.0 --subtract-bg --trim-edges 30  --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-k-iv-6101-79.pdf]]

This is the stonger member of the [K IV] doublet. 
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line k-iv-6101-79 --bcombo P-101 --smooth 5 --mask-out-stars --star-mask-threshold 2.0 --subtract-bg --trim-edges 30 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-k-iv-6101-79.pdf]]

And this is the weaker member of the [K IV] doublet. Probably the weakest line that we credibly detect in the bow shock
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line k-iv-6795-1 --bcombo P-101 --smooth 9 --mask-out-stars --star-mask-threshold 3.0 --subtract-bg --trim-edges 30 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-k-iv-6795-1.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line cl-iv-8045-62 --bcombo E-007 --smooth 5 --mask-out-stars --star-mask-threshold 5.0 --subtract-bg --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-cl-iv-8045-62.pdf]]

Blend with H_2 line
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line cl-iv-8045-62 --bcombo P-101 --smooth 5 --mask-out-stars --star-mask-threshold 5.0 --subtract-bg --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-cl-iv-8045-62.pdf]]


#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line ar-iv-7262-7 --bcombo E-007 --smooth 9 --mask-out-stars --star-mask-threshold 1.0 --subtract-bg --trim-edges 20 --fix-continuum --no-mark-moments-filaments
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-ar-iv-7262-7.pdf]]

This could do with using the hyperlocal continuum, since the continuum is a bit oversubtracted. That did help somewhat.
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line ar-iv-7262-7 --bcombo P-101 --smooth 9 --mask-out-stars --star-mask-threshold 2.0 --subtract-bg --trim-edges 20 --fix-continuum --no-mark-moments-filaments
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-ar-iv-7262-7.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line ar-iv-7170-5 --bcombo E-007 --smooth 9 --mask-out-stars --star-mask-threshold 2.0 --subtract-bg  --trim-edges 20 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-ar-iv-7170-5.pdf]]

This has a much better zero level, and is clearly the best of the [Ar
IV] auroral lines
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line ar-iv-7170-5 --bcombo P-101 --smooth 9 --mask-out-stars --star-mask-threshold 2.0 --subtract-bg --trim-edges 20 --fix-continuum 
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-ar-iv-7170-5.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line uil-7237-66 --bcombo E-007 --smooth 3 --mask-out-stars --star-mask-threshold 5.0 --subtract-bg --trim-edges 20 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-uil-7237-66.pdf]]

This is the H_2 7238.21 line, blended with the central one of the 3 [Ar
IV] auroral lines 7237.40. The hyper locq continuum fix helps q
bit. But we still cannot reliably measure this line from the bow
shock, since the H_2 line from the filaments is twice as strong.
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line uil-7237-66 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 5.0 --subtract-bg --trim-edges 20 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-uil-7237-66.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line ar-iv-4711-37 --bcombo E-007 --smooth 3 --mask-out-stars --star-mask-threshold 2 --subtract-bg --fix-continuum --hyper-local-red 4 --hyper-local-blue 4
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-ar-iv-4711-37.pdf]]


This is a strong line from the bow shock, but is contaminated with He
I 4713 emission, which dominates the emission in the diffuse and
filaments zones. We should be able to subtract this off. 

#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line ar-iv-4711-37 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 2 --subtract-bg --fix-continuum --hyper-local-red 4 --hyper-local-blue 4
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-ar-iv-4711-37.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line cl-iv-7530-8 --bcombo E-007 --smooth 5 --mask-out-stars --star-mask-threshold 3 --subtract-bg --trim-edges 20 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-cl-iv-7530-8.pdf]]

This is a nice, well-isolated line, but it is not clear what use it is
to us. Except maybe for calculating the Cl/Ar abundance. 
#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line cl-iv-7530-8 --bcombo P-101 --smooth 5 --mask-out-stars --star-mask-threshold 3 --subtract-bg --trim-edges 20 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-cl-iv-7530-8.pdf]]


**** Fe lines

Blend with 4985.90. This is weak from the bow shock, but is stronger from the other zones, especially in the west of the nebula.
#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line fe-iii-4987-20 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 2 --subtract-bg --trim-edges 20 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-fe-iii-4987-20.pdf]]

Rather weak and unconvincing line
#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line fe-iii-5270-40 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 2 --subtract-bg --trim-edges 10 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-fe-iii-5270-40.pdf]]

Again weak with lots of artefacts.
#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line fe-iii-4658-10 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 2 --subtract-bg --trim-edges 10 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-fe-iii-4658-10.pdf]]

Even weaker
#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line fe-iii-4701-62 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 2 --subtract-bg --trim-edges 30 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-fe-iii-4701-62.pdf]]


**** Neutral lines
#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line o-i-8446-48 --bcombo E-007 --smooth 3 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-o-i-8446-48.pdf]]

This is ok, but it is hampered by the nearby H I line, and ~--fix-continuum~ is not working well.
#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line o-i-8446-48 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 2 --subtract-bg --trim-edges 0 --fix-continuum --continuum-zone I
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-o-i-8446-48.pdf]]

The [N I] lines are a bit of a mess because they are a doublet. Also blended with [Ar III]
#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line n-i-5199-00 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 2 --subtract-bg --trim-edges 0 --fix-continuum --hyper-local-red 4 --hyper-local-blue 4 --no-mark-moments-bow-shock
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-n-i-5199-00.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line n-i-8216-34 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 2 --subtract-bg --trim-edges 10 --fix-continuum --continuum-zone I 
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-n-i-8216-34.pdf]]

**** Molecular Hydrogen lines
#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line uil-8150-72 --bcombo E-007 --smooth 3 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-uil-8150-72.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line uil-8150-72 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 10 --subtract-bg --fix-continuum --continuum-zone 0
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-uil-8150-72.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line uil-9029-20 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 10 --subtract-bg --fix-continuum --continuum-zone 0
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-uil-9029-20.pdf]]

**** [O III] lines
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line o-iii-5006-84 --bcombo E-007 --smooth 0  --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-o-iii-5006-84.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line o-iii-5006-84 --bcombo P-101 --smooth 1 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-o-iii-5006-84.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line o-iii-4958-91 --bcombo P-101 --smooth 1 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-o-iii-4958-91.pdf]]

**** Low ionization forbidden lines
- [X] For some reason [N II] 5755 is missing and so is [O I] 6363
  - /found them/ they are in the `n346-bow-lines` directory

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line s-ii-6730-816 --bcombo E-007 --smooth 0 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-s-ii-6730-816.pdf]]

These [S II] lines are both beautiful, with very high signal to noise. 
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line s-ii-6730-816 --bcombo P-101 --smooth 0  --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-s-ii-6730-816.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line s-ii-6716-44 --bcombo P-101 --smooth 0  --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-s-ii-6716-44.pdf]]

This one is good for P-101 but bad for P-007
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line o-i-6363-78 --bcombo P-101 --smooth 0  --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-o-i-6363-78.pdf]]

This one too. In both cases, we can see vestiges of the nigh-sky contribution to the same line.
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line o-i-6300-30 --bcombo P-101 --smooth 0  --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-o-i-6300-30.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line o-ii-7319-99 --bcombo P-101 --smooth 0  --subtract-bg --majsk-out-stars --star-mask-threshold 15
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines]]
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line o-ii-7330-73 --bcombo P-101 --smooth 0  --subtract-bg --mask-out-stars --star-mask-threshold 15
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-o-ii-7330-73.pdf]]


#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line n-ii-6583-45 --bcombo P-101 --smooth 0  --subtract-bg --mask-out-stars --star-mask-threshold 15
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-n-ii-6583-45.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line n-ii-5755-08 --bcombo P-101 --smooth 3 --subtract-bg --mask-out-stars --star-mask-threshold 15 --fix-continuum --continuum-zone 0,II
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-n-ii-5755-08.pdf]]

Very weak and noisy. Possible blend with other line at 7877, but this shows up more in P-101 than in P-007, which is odd.
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line p-ii-7875-99 --bcombo P-101 --smooth 9  --subtract-bg --mask-out-stars --star-mask-threshold 2
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-p-ii-7875-99.pdf]]

This has a very close by He I line, slightly to the red
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line cl-ii-8578-69 --bcombo P-101 --smooth 3 --subtract-bg --mask-out-stars --star-mask-threshold 5 --fix-continuum --continuum-zone 0,II --hyper-local-red 6
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-cl-ii-8578-69.pdf]]

Barely detected
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line cl-ii-9123-60 --bcombo P-101 --smooth 6 --subtract-bg --mask-out-stars --star-mask-threshold 2 --trim-edges 20 --fix-continuum --continuum-zone 0,II
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-cl-ii-9123-60.pdf]]

**** [C I] 8727 line
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line c-i-8727-13 --bcombo P-101 --smooth 1  --subtract-bg --mask-out-stars --star-mask-threshold 20 --fix-continuum --continuum-zone 0
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-c-i-8727-13.pdf]]

**** Si II lines
This is totally dominated by the YSO
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line si-ii-6371-36 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 5  --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-si-ii-6371-36.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line si-ii-6347-11 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 5  --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-si-ii-6347-11.pdf]]

**** H I lines
#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line h-i-6562-79 --bcombo P-101  --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-6562-79.pdf]]


#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-4861-32 --bcombo P-101 --smooth 1 --mask-out-stars --star-mask-threshold 15 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-4861-32.pdf]]

This one is weird. Not really useable. Although ~--fix-continuum~ does help a bit
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8306-11 --bcombo P-101 --smooth 5 --mask-out-stars --star-mask-threshold 3 --subtract-bg --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8306-11.pdf]]

Oversubtracted continuum, which is largely fixed by ~--fix-continuum~
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8314-26 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 10 --subtract-bg --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8314-26.pdf]]

This would be better with the central pixel moved one to the red
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8323-42 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 10 --subtract-bg --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8323-42.pdf]]

Affected by inaccurate baseline. Mostly fixed by ~--fix-continuum~. Broader line that its neighbours, suggesting a blend, probably with He I
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8345-55 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 10 --subtract-bg --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8345-55.pdf]]


This is affected by a blend with He I 8361.73
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8359-00 --bcombo P-101 --smooth 2 --mask-out-stars --star-mask-threshold 10 --subtract-bg --fix-continuum --hyper-local-red 5
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8359-00.pdf]]

Also possibly has a blend in the red wing, but it is less affected than the previous one
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8374-48 --bcombo P-101 --smooth 2 --mask-out-stars --star-mask-threshold 10 --subtract-bg --fix-continuum --hyper-local-red 4
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8374-48.pdf]]

This one is redder than it should be, and is also affected by a sky
line on the blue side
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8413-32 --bcombo P-101 --smooth 2 --mask-out-stars --star-mask-threshold 10 --subtract-bg 
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8413-32.pdf]]

This one looks fine. This is the highest Pa line that is unaffected by anything obvious.
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8437-96 --bcombo P-101 --smooth 2 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8437-96.pdf]]

Also fine. 
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8467-26 --bcombo P-101 --smooth 2 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8467-26.pdf]]

Mostly fine. Has a slight bulge on the blue side, that might effect the A pixel
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8502-49 --bcombo P-101 --smooth 2 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8502-49.pdf]]

Fine in P101, but funny tinge to image in P007. Has an H_2 line 4
pixels to the red, but unaffected by it
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8545-38 --bcombo P-101 --smooth 1 --mask-out-stars --star-mask-threshold 10 --subtract-bg --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8545-38.pdf]]

This seems to be blended with something, although I never identified
it as a blend in the table. Evidence is a larger m2 than its neighbours, plus the fact that the peak is in the B pixel, not the G one
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8598-39 --bcombo P-101 --smooth 1 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8598-39.pdf]]

This one is great, and also with rest wavelength right in middle of pixel
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8665-02 --bcombo P-101 --smooth 1 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8665-02.pdf]]

Also fine.
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8750-47 --bcombo P-101 --smooth 1 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8750-47.pdf]]

Again, fine.
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8862-79 --bcombo P-101 --smooth 1 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-8862-79.pdf]]

And fine again. Although there is a H_2 line 3 pixels to the red, it is mostly unaffected by it, especially in the P-007 version
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-9014-91 --bcombo P-101 --smooth 1 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-9014-91.pdf]]

This one is mostly fine, except it clearly shows the influence in Zone 0 of the H_2 5-2 S(1) line at 9229.19.  Strangely, I never mentioned this in the Mabel paper, even though I do remember being previously aware of it.

It should be similar strength to the 5-2 S(3) line at 9019.30 (just to
red of the previous H I 9015 line), which means it should be a bit
over 10% of the H I 9229.01 line in Zone 0
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-9229-01 --bcombo P-101 --smooth 1 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-h-i-9229-01.pdf]]


***** ESO comparions for H lines
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-4861-32 --bcombo E-007 --smooth 1 --mask-out-stars --star-mask-threshold 15 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-h-i-4861-32.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-8750-47 --bcombo E-007 --smooth 1 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-h-i-8750-47.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line h-i-9229-01 --bcombo E-007 --smooth 1 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-h-i-9229-01.pdf]]

**** Medium ionization forbidden lines
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line ar-iii-7135-78 --bcombo E-007 --smooth 0 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-ar-iii-7135-78.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line ar-iii-7135-78 --bcombo P-101 --smooth 0 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-ar-iii-7135-78.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line ar-iii-7751-10 --bcombo P-101 --smooth 0 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-ar-iii-7751-10.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line ar-iii-5191-82 --bcombo E-007 --smooth 9 --mask-out-stars --star-mask-threshold 2 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-ar-iii-5191-82.pdf]]


This is pretty terrible. Super weak. [N I] lines get in the way on the red side. It is helped somewhat by the local continuum, but the central pixe seems to be off by one.
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line ar-iii-5191-82 --bcombo P-101 --smooth 7 --mask-out-stars --star-mask-threshold 5 --subtract-bg --fix-continuum --continuum-zone III
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-ar-iii-5191-82.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line cl-iii-5537-88 --bcombo E-007 --smooth 3 --mask-out-stars --star-mask-threshold 2 --subtract-bg --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-cl-iii-5537-88.pdf]]

These [Cl III] lines are OK, but rather noisy. They show mild
improvement from the ~--fix-continuum~ option, but not a lot.
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line cl-iii-5537-88 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 2 --subtract-bg --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-cl-iii-5537-88.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line cl-iii-5517-71 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 2 --subtract-bg --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-cl-iii-5517-71.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line s-iii-6312-06 --bcombo  E-007 --smooth 1 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-s-iii-6312-06.pdf]]

Both [S III] lines are pretty perfect, although the 6312 line has rest
wavelength right on a edge of pixel. 
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line s-iii-6312-06 --bcombo P-101 --smooth 1 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-s-iii-6312-06.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line s-iii-9068-90 --bcombo P-101 --smooth 1 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-s-iii-9068-90.pdf]]

**** He I lines
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-i-6678-15 --bcombo P-101 --smooth 0 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-6678-15.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-i-5875-62 --bcombo P-101 --smooth 0 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-5875-62.pdf]]

#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-i-5015-68 --bcombo E-007 --smooth 0 --mask-out-stars --star-mask-threshold 10 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-he-i-5015-68.pdf]]

Badly affected by [O III] 5007 line
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-i-5015-68 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 10 --subtract-bg --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-5015-68.pdf]]


OK, but weakish and affected by stellar absorption
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-i-4921-93 --bcombo P-101 --smooth 5 --mask-out-stars --star-mask-threshold 2 --subtract-bg --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-4921-93.pdf]]


#+begin_src sh :dir ../data/n346-bow-lines :results file 
  python ../../scripts/compare-two-maps.py --line he-i-5047-74 --bcombo E-007 --smooth 6 --mask-out-stars --star-mask-threshold 2 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-he-i-5047-74.pdf]]


This is flnked by Si II lines on both sides, but it is quite well
isolated nonetheless. Although it is a pretty weak line
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-i-5047-74 --bcombo P-101 --smooth 6 --mask-out-stars --star-mask-threshold 2 --subtract-bg --fix-continuum --hyper-local-blue 2 --hyper-local-red 2
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-5047-74.pdf]]

This one is really good, and is pretty strong. 
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-i-7065-28 --bcombo P-101 --smooth 1 --mask-out-stars --star-mask-threshold 2 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-7065-28.pdf]]

Also pretty good, albeit 3 time weaker than the previous line
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-i-7281-35 --bcombo P-101 --smooth 1 --mask-out-stars --star-mask-threshold 2 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-7281-35.pdf]]

This is 10 times weaker again, but given that it is not too bad
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-i-7499-85 --bcombo P-101 --smooth 5 --mask-out-stars --star-mask-threshold 2 --subtract-bg --trim-edges 20 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-7499-85.pdf]]

Blended with OH sky line, so totally useless
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-i-7816-13 --bcombo P-101 --smooth 5 --mask-out-stars --star-mask-threshold 2 --subtract-bg --trim-edges 20 --fix-continuum
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-7816-13.pdf]]

Too weak and too much other stuff around it, such as H_2 line to red
and unidentified line to blue at 8512 that seems to be from bow shock mainly
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-i-8518-04 --bcombo P-101 --smooth 5 --mask-out-stars --star-mask-threshold 2 --subtract-bg --trim-edges 20 --fix-continuum --continuum-zone III
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-8518-04.pdf]]

Blend with an unidentified line on the red side. Useless as a result
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-i-8528-95 --bcombo P-101 --smooth 5 --mask-out-stars --star-mask-threshold 2 --subtract-bg --trim-edges 20 --fix-continuum --continuum-zone III
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-8528-95.pdf]]

Blend with [Cl II] 8579 affects the blue side of the line
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-i-8582-61 --bcombo P-101 --smooth 5 --mask-out-stars --star-mask-threshold 2 --subtract-bg --fix-continuum --hyper-local-blue 6
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-8582-61.pdf]]

Not much use due to very strong sky line just to the blue
#+begin_src sh :dir ../data/n346-bow-lines :results file
       python ../../scripts/compare-two-maps.py --line he-i-8776-71 --bcombo P-101 --smooth 5 --mask-out-stars --star-mask-threshold 2 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-8776-71.pdf]]

Seriously affected by [S III] 9069 line. Cannot be salvaged, unfortunately.
#+begin_src sh :dir ../data/n346-bow-lines :results file
       python ../../scripts/compare-two-maps.py --line he-i-9063-29 --bcombo P-101 --smooth 3 --mask-out-stars --star-mask-threshold 2 --subtract-bg
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-9063-29.pdf]]



This one is almost good, despite being weak. There is another line
blended on the red side, though at 9213
#+begin_src sh :dir ../data/n346-bow-lines :results file
  python ../../scripts/compare-two-maps.py --line he-i-9210-28 --bcombo P-101 --smooth 5 --mask-out-stars --star-mask-threshold 2 --subtract-bg --trim-edges 20 --fix-continuum --hyper-local-red 6
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-he-i-9210-28.pdf]]

**** Si III 5739.73 permitted high ionization
#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line si-iii-5739-73 --bcombo E-007 --smooth 9 --mask-out-stars --star-mask-threshold 2 --subtract-bg --trim-edges 15
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-E-007-si-iii-5739-73.pdf]]

This looks like it might be a blend with a medium ionization line slightly to the red

#+begin_src sh :dir ../data/n346-bow-lines :results file
python ../../scripts/compare-two-maps.py --line si-iii-5739-73 --bcombo P-101 --smooth 9 --mask-out-stars --star-mask-threshold 2 --subtract-bg --fix-continuum --trim-edges 25 --hyper-local-blue 4 --continuum-zone IV
#+end_src

#+RESULTS:
[[file:/Users/will/Dropbox/muse-hii-regions/data/n346-bow-lines/figs-compare/P-007-P-101-si-iii-5739-73.pdf]]
* Further analysis of the PZ maps
This wlud be better in another file. 

